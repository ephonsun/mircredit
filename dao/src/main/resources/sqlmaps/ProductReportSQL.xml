<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ProductReportSQL">
	<typeAlias alias="ProductTypeTreeBean"
		type="com.banger.mobile.domain.model.report.ProductTypeTreeBean" />
	
	<typeAlias alias="ProductReportBean"
		type="com.banger.mobile.domain.model.report.ProductReportBean" />
		
	<typeAlias alias="ProductTypeTotalBean"
		type="com.banger.mobile.domain.model.report.ProductTypeTotalBean" />
	
	<!-- 产品及类型树 -->
	<resultMap class="ProductTypeTreeBean" id="ProductTypeTreeBeanResult">
		<result column="ID" property="id" />
		<result column="PARENT_ID" property="parentId" />
		<result column="CODE" property="code" />
		<result column="NAME" property="name" />
		<result column="TYPE" property="type" />
	</resultMap>
	
	<!-- 产品报表 -->
	<resultMap class="ProductReportBean" id="ProductReportBeanResult">
		<result column="PRODUCT_ID" property="productId" />
		<result column="PRODUCT_CODE" property="productCode" />
		<result column="PRODUCT_NAME" property="productName" />
		<result column="TEMPLATE_ID" property="templateId" />
		<result column="TEMPLATE_NAME" property="templateName" />
		<result column="TEMPLATE_FIELD_ID" property="templateFieldId" />
		<result column="FIELD_CODEDATA_VALUE" property="fieldCodeDataValue" />
		<result column="USER_ID" property="userId" />
		<result column="USER_NAME" property="userName" />
		<result column="BUY_MONEY" property="buyMoney" />
		<result column="DEPT_ID" property="deptId" />
	</resultMap>
	
	<!-- 产品类型销售额 -->
	<resultMap class="ProductTypeTotalBean" id="ProductTypeTotalBeanResult">
		<result column="TEMPLATE_ID" property="templateId" />
		<result column="TEMPLATE_NAME" property="templateName" />
		<result column="USER_ID" property="userId" />
		<result column="BUY_MONEY" property="buyMoney" />
		<result column="DEPT_ID" property="deptId" />
		<result column="FARTHER_ID" property="fartherId" />
	</resultMap>
	
	<!-- 产品类型树 -->
	<select id="GetProductTypeTreeList" resultMap="ProductTypeTreeBeanResult" parameterClass="java.util.Map">
		<![CDATA[
			WITH P_TYPE(TEMPLATE_ID, PARENT_TEMPLATE_ID, PRODUCT_CODE,TEMPLATE_NAME,TYPE) AS ( 
			  SELECT TEMPLATE_ID,0 AS PARENT_TEMPLATE_ID,'' AS PRODUCT_CODE,TEMPLATE_NAME,'D' AS TYPE
			    FROM PDT_TEMPLATE WHERE IS_DEL=0 AND TEMPLATE_STATE=1 
			    UNION ALL 
			    SELECT FIELD.TEMPLATE_FIELD_ID AS TEMPLATE_ID,FIELD.TEMPLATE_ID AS PARENT_TEMPLATE_ID,'' AS PRODUCT_CODE,FIELD.TEMPLATE_FIELD_NAME AS TEMPLATE_NAME,'D' AS TYPE
			    FROM  PDT_TEMPLATE_FIELD AS FIELD 
			    LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			    WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND TEMP.TEMPLATE_STATE=1 
			    UNION ALL 
			    SELECT CODE.FIELD_CODEDATA_ID AS TEMPLATE_ID,CODE.TEMPLATE_FIELD_ID AS PARENT_TEMPLATE_ID,'' AS PRODUCT_CODE,CODE.FIELD_CODEDATA_VALUE AS TEMPLATE_NAME,'D' AS TYPE
			    FROM PDT_FIELD_CODEDATA AS CODE 
			    LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON CODE.TEMPLATE_FIELD_ID=FIELD.TEMPLATE_FIELD_ID
			    LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			    WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND TEMP.TEMPLATE_STATE=1 
			    UNION ALL 
			    SELECT PRO.PRODUCT_ID AS TEMPLATE_ID,
			    (CASE WHEN PT.TEMPLATE_FIELD_ID IS NULL THEN PRO.TEMPLATE_ID ELSE PT.FIELD_CODEDATA_ID END) AS  PARENT_TEMPLATE_ID,
			    PRO.PRODUCT_CODE,PRO.PRODUCT_NAME AS TEMPLATE_NAME,'U' AS TYPE 
			    FROM PDT_PRODUCT AS PRO 
			    LEFT JOIN (
			        SELECT PF.PRODUCT_ID,PT.* FROM PDT_PRODUCT_FIELD AS PF 
			        INNER JOIN(
			            SELECT FIELD.TEMPLATE_ID,FIELD.TEMPLATE_FIELD_NAME,FIELD.TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_ID,CODE.FIELD_CODEDATA_VALUE
			            FROM PDT_FIELD_CODEDATA AS CODE 
			            LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID 
			            LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID 
			            WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0 AND TEMP.TEMPLATE_STATE=1
			        ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        WHERE PF.IS_DEL=0 
			    ) AS PT ON PT.PRODUCT_ID=PRO.PRODUCT_ID 
			    WHERE PRO.IS_DEL=0 
			), 
			temp(TEMPLATE_ID, PARENT_TEMPLATE_ID, PRODUCT_CODE,TEMPLATE_NAME,TYPE) as ( 
				select TEMPLATE_ID, PARENT_TEMPLATE_ID, PRODUCT_CODE,TEMPLATE_NAME,TYPE from P_TYPE WHERE 1=1 
		]]>
		<isNotEmpty property="code">
			<![CDATA[ AND PRODUCT_CODE LIKE '%$code$%' ]]>
		</isNotEmpty>
		<isNotEmpty property="name">
			<![CDATA[ AND TEMPLATE_NAME LIKE '%$name$%' ]]>
		</isNotEmpty>
		<![CDATA[
				union all 
				select parent.TEMPLATE_ID,parent.PARENT_TEMPLATE_ID,parent.PRODUCT_CODE,parent.TEMPLATE_NAME,parent.TYPE from temp as child, 
				P_TYPE as parent where child.PARENT_TEMPLATE_ID = parent.TEMPLATE_ID 
			) 
			select distinct TEMPLATE_ID AS ID, PARENT_TEMPLATE_ID AS PARENT_ID, PRODUCT_CODE AS CODE,TEMPLATE_NAME AS NAME,TYPE from temp ORDER BY TEMPLATE_ID
		]]>
	</select>
	
	<!-- 产品报表 -->
	<select id="GetProductReportList" resultMap="ProductReportBeanResult" parameterClass="java.util.Map">
		<![CDATA[
			SELECT PU.PRODUCT_ID,PU.PRODUCT_CODE,PU.PRODUCT_NAME,PU.TEMPLATE_ID,PU.TEMPLATE_NAME,PU.TEMPLATE_FIELD_ID,PU.FIELD_CODEDATA_VALUE,PU.USER_ID,
			PU.DEPT_ID,PU.USER_NAME,SUM(BUY_MONEY) AS BUY_MONEY
			FROM(
			    SELECT P.*,USERS.USER_NAME,USERS.DEPT_ID FROM SYS_USER AS USERS
			    RIGHT JOIN(
			        SELECT PA.*,PC.USER_ID,PC.BUY_MONEY FROM(
			            SELECT (CASE WHEN PF.PRODUCT_ID IS NULL THEN PRO.PRODUCT_ID ELSE PF.PRODUCT_ID END) AS PRODUCT_ID,
			            PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,(CASE WHEN PT.TEMPLATE_ID IS NULL THEN PRO.TEMPLATE_ID ELSE PT.TEMPLATE_ID END) AS TEMPLATE_ID,
			            (CASE WHEN PT.TEMPLATE_ID IS NULL THEN (SELECT TEMPLATE_NAME FROM PDT_TEMPLATE WHERE TEMPLATE_ID=PRO.TEMPLATE_ID) ELSE PT.TEMPLATE_NAME END) AS TEMPLATE_NAME,
			            PT.TEMPLATE_FIELD_ID,PT.FIELD_CODEDATA_VALUE 
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			            RIGHT JOIN PDT_PRODUCT AS PRO ON PRO.PRODUCT_ID=PF.PRODUCT_ID AND PRO.IS_DEL=0
			        ) AS PA
			        LEFT JOIN (
			            SELECT PCUS.PRODUCT_ID,PCUS.USER_ID,SUM(PCUS.BUY_MONEY) AS BUY_MONEY
			            FROM PDT_PRODUCT_CUSTOMER AS PCUS 
			            WHERE PCUS.IS_DEL=0 
		]]>
		<isNotEmpty property="startDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')>='$startDate$' ]]>
		</isNotEmpty>
		<isNotEmpty property="endDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')<='$endDate$' ]]>
		</isNotEmpty>
		<![CDATA[
			            GROUP BY PCUS.PRODUCT_ID,PCUS.USER_ID
			        ) AS PC ON PA.PRODUCT_ID=PC.PRODUCT_ID
			    ) AS P ON P.USER_ID=USERS.USER_ID AND USERS.IS_DEL=0
			    WHERE USERS.USER_ID IN($userIds$)
			    UNION ALL
			    SELECT DISTINCT PP.PRODUCT_ID,PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,PP.TEMPLATE_ID,PP.TEMPLATE_NAME,
			    PP.TEMPLATE_FIELD_ID,PP.FIELD_CODEDATA_VALUE,PRO.USER_ID,0 AS BUY_MONEY,PRO.USER_NAME,PRO.DEPT_ID 
			    FROM (
			        SELECT PF.PRODUCT_ID,PT.*FROM PDT_PRODUCT_FIELD AS PF
			        INNER JOIN(
			            SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			            FROM PDT_FIELD_CODEDATA AS CODE
			            LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			            LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			            WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			        ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        UNION ALL
			        SELECT A.*,B.TEMPLATE_FIELD_ID,B.FIELD_CODEDATA_VALUE FROM (
			            SELECT PDT.PRODUCT_ID,PDT.TEMPLATE_ID,TEM.TEMPLATE_NAME
			            FROM PDT_PRODUCT AS PDT
			            INNER JOIN(
			                SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			                TSK_MARKETING_EXECUTE AS EXC
			                LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			                LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			                WHERE EXC.USER_ID IN($userIds$)
			            ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			            LEFT JOIN PDT_TEMPLATE AS TEM ON TEM.TEMPLATE_ID=PDT.TEMPLATE_ID
			        ) AS A 
			        LEFT JOIN(
			            SELECT PF.PRODUCT_ID,PT.*
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        ) AS B ON A.PRODUCT_ID=B.PRODUCT_ID
			    ) AS PP
			    RIGHT JOIN(
			        SELECT PDT.PRODUCT_ID,PDT.PRODUCT_CODE,PDT.PRODUCT_NAME,PDT.TEMPLATE_ID,MP.USER_ID,MP.USER_NAME,MP.DEPT_ID
			        FROM PDT_PRODUCT AS PDT
			        INNER JOIN(
			            SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			            TSK_MARKETING_EXECUTE AS EXC
			            LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			            LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			            WHERE EXC.USER_ID IN($userIds$)
			        ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			    )AS PRO ON PRO.PRODUCT_ID=PP.PRODUCT_ID
			) AS PU WHERE  1=1 
		]]>
		<isNotEmpty property="startEndDate">
			<![CDATA[ $startEndDate$ ]]>
		</isNotEmpty>
		<isNotEmpty property="proId">
			<![CDATA[ AND  PU.PRODUCT_ID IN($proId$) ]]>
		</isNotEmpty>
		<![CDATA[
			GROUP BY PU.PRODUCT_ID,PU.PRODUCT_CODE,PU.PRODUCT_NAME,PU.TEMPLATE_ID,PU.TEMPLATE_FIELD_ID,PU.FIELD_CODEDATA_VALUE,PU.USER_ID,PU.USER_NAME,PU.TEMPLATE_NAME,PU.DEPT_ID 
			ORDER BY PU.USER_ID 
		]]>
	</select>
	
	<!-- 查询有购买产品记录的用户以及有营销产品的用户 -->
	<select id="GetProductUserList" resultMap="ProductTypeTreeBeanResult" parameterClass="java.util.Map">
		<![CDATA[
			SELECT A.ID,A.NAME,SUM(PARENT_ID) AS PARENT_ID,A.CODE,A.TYPE FROM(
			    SELECT DISTINCT * FROM(
			        SELECT PU.* FROM(
			            SELECT DISTINCT CT.USER_ID AS ID,U.USER_NAME AS NAME,1 AS PARENT_ID,'' AS CODE,'' AS TYPE,PDT.PRODUCT_ID,U.DEPT_ID
			            FROM PDT_PRODUCT_CUSTOMER AS CT
			            INNER JOIN PDT_PRODUCT AS PDT ON PDT.PRODUCT_ID=CT.PRODUCT_ID AND PDT.IS_DEL=0
			            LEFT JOIN SYS_USER AS U ON U.USER_ID=CT.USER_ID
			            WHERE CT.IS_DEL=0 AND CT.USER_ID IN($userIds$)
			        ) AS PU WHERE 1=1 
		]]>
		<isNotEmpty property="proId">
			<![CDATA[ AND  PU.PRODUCT_ID IN($proId$) ]]>
		</isNotEmpty>
		<isNotEmpty property="startEndDate">
			<![CDATA[ $startEndDate$ ]]>
		</isNotEmpty>
		<isNotEmpty property="userSearchDate">
			<![CDATA[ $userSearchDate$ ]]>
		</isNotEmpty>
		<![CDATA[
			        UNION ALL 
			        SELECT PU.* FROM (
			            SELECT DISTINCT EXC.USER_ID AS ID,U.USER_NAME AS NAME,1 AS PARENT_ID,'' AS CODE,'' AS TYPE,MARK.PRODUCT_ID,U.DEPT_ID
			            FROM TSK_MARKETING_EXECUTE AS EXC
			            INNER JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			            LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			            WHERE EXC.USER_ID IN($userIds$)
			        ) AS PU WHERE 1=1 AND PU.PRODUCT_ID<>0 
		]]>
		<isNotEmpty property="proId">
			<![CDATA[ AND  PU.PRODUCT_ID IN($proId$) ]]>
		</isNotEmpty>
		<isNotEmpty property="startEndDate">
			<![CDATA[ $startEndDate$ ]]>
		</isNotEmpty>
		<![CDATA[
			    )
			) AS A GROUP BY A.ID,A.NAME,A.CODE,A.TYPE 
		]]>
	</select>
	
	<!-- 查询用户的产品大类的销售额 -->
	<select id="GetProductTypeTotalList" resultMap="ProductTypeTotalBeanResult" parameterClass="java.util.Map">
		<![CDATA[
			SELECT PU.TEMPLATE_ID,PU.TEMPLATE_NAME,PU.USER_ID,PU.DEPT_ID,SUM(BUY_MONEY) AS BUY_MONEY,PU.TEMPLATE_ID AS FARTHER_ID
			FROM(
			    SELECT P.*,USERS.USER_NAME,USERS.DEPT_ID FROM SYS_USER AS USERS
			    RIGHT JOIN(
			        SELECT PA.*,PC.USER_ID,PC.BUY_MONEY FROM(
			            SELECT (CASE WHEN PF.PRODUCT_ID IS NULL THEN PRO.PRODUCT_ID ELSE PF.PRODUCT_ID END) AS PRODUCT_ID,
			            PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,(CASE WHEN PT.TEMPLATE_ID IS NULL THEN PRO.TEMPLATE_ID ELSE PT.TEMPLATE_ID END) AS TEMPLATE_ID,
			            (CASE WHEN PT.TEMPLATE_ID IS NULL THEN (SELECT TEMPLATE_NAME FROM PDT_TEMPLATE WHERE TEMPLATE_ID=PRO.TEMPLATE_ID) ELSE PT.TEMPLATE_NAME END) AS TEMPLATE_NAME,
			            PT.TEMPLATE_FIELD_ID,PT.FIELD_CODEDATA_VALUE 
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,FIELD.TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			            RIGHT JOIN PDT_PRODUCT AS PRO ON PRO.PRODUCT_ID=PF.PRODUCT_ID AND PRO.IS_DEL=0
			        ) AS PA
			        LEFT JOIN (
			            SELECT PCUS.PRODUCT_ID,PCUS.USER_ID,SUM(PCUS.BUY_MONEY) AS BUY_MONEY
			            FROM PDT_PRODUCT_CUSTOMER AS PCUS 
			            WHERE PCUS.IS_DEL=0 
		]]>
		<isNotEmpty property="startDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')>='$startDate$' ]]>
		</isNotEmpty>
		<isNotEmpty property="endDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')<='$endDate$' ]]>
		</isNotEmpty>
		<![CDATA[
			            GROUP BY PCUS.PRODUCT_ID,PCUS.USER_ID
			        ) AS PC ON PA.PRODUCT_ID=PC.PRODUCT_ID
			    ) AS P ON P.USER_ID=USERS.USER_ID AND USERS.IS_DEL=0
			    WHERE USERS.USER_ID IN($userIds$)
			    UNION ALL
			    SELECT DISTINCT PP.PRODUCT_ID,PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,PP.TEMPLATE_ID,PP.TEMPLATE_NAME,
			    PP.TEMPLATE_FIELD_ID,PP.FIELD_CODEDATA_VALUE,PRO.USER_ID,0 AS BUY_MONEY,PRO.USER_NAME,PRO.DEPT_ID 
			    FROM (
			        SELECT PF.PRODUCT_ID,PT.*FROM PDT_PRODUCT_FIELD AS PF
			        INNER JOIN(
			            SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			            FROM PDT_FIELD_CODEDATA AS CODE
			            LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			            LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			            WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			        ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        UNION ALL
			        SELECT A.*,B.TEMPLATE_FIELD_ID,B.FIELD_CODEDATA_VALUE FROM (
			            SELECT PDT.PRODUCT_ID,PDT.TEMPLATE_ID,TEM.TEMPLATE_NAME
			            FROM PDT_PRODUCT AS PDT
			            INNER JOIN(
			                SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			                TSK_MARKETING_EXECUTE AS EXC
			                LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			                LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			                WHERE EXC.USER_ID IN($userIds$)
			            ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			            LEFT JOIN PDT_TEMPLATE AS TEM ON TEM.TEMPLATE_ID=PDT.TEMPLATE_ID
			        ) AS A 
			        LEFT JOIN(
			            SELECT PF.PRODUCT_ID,PT.*
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        ) AS B ON A.PRODUCT_ID=B.PRODUCT_ID
			    ) AS PP
			    RIGHT JOIN(
			        SELECT PDT.PRODUCT_ID,PDT.PRODUCT_CODE,PDT.PRODUCT_NAME,PDT.TEMPLATE_ID,MP.USER_ID,MP.USER_NAME,MP.DEPT_ID
			        FROM PDT_PRODUCT AS PDT
			        INNER JOIN(
			            SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			            TSK_MARKETING_EXECUTE AS EXC
			            LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			            LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			            WHERE EXC.USER_ID IN($userIds$)
			        ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			    )AS PRO ON PRO.PRODUCT_ID=PP.PRODUCT_ID
			) AS PU WHERE 1=1 
		]]>
		<isNotEmpty property="startEndDate">
			<![CDATA[ $startEndDate$ ]]>
		</isNotEmpty>
		<isNotEmpty property="proId">
			<![CDATA[ AND  PU.PRODUCT_ID IN($proId$) ]]>
		</isNotEmpty>
		<![CDATA[
			GROUP BY PU.TEMPLATE_ID,PU.USER_ID,PU.TEMPLATE_NAME,PU.DEPT_ID,PU.TEMPLATE_ID order by PU.USER_ID
		]]>
	</select>
	
	<!-- 查询用户的产品子类型的销售额 -->
	<select id="GetProductSubTypeTotalList" resultMap="ProductTypeTotalBeanResult" parameterClass="java.util.Map">
		<![CDATA[
			SELECT PU.TEMPLATE_FIELD_ID  AS TEMPLATE_ID,PU.FIELD_CODEDATA_VALUE AS TEMPLATE_NAME,PU.USER_ID,PU.DEPT_ID,
			SUM(BUY_MONEY) AS BUY_MONEY,PU.TEMPLATE_ID AS FARTHER_ID
			FROM(
			    SELECT P.*,USERS.USER_NAME,USERS.DEPT_ID FROM SYS_USER AS USERS
			    RIGHT JOIN(
			        SELECT PA.*,PC.USER_ID,PC.BUY_MONEY FROM(
			            SELECT (CASE WHEN PF.PRODUCT_ID IS NULL THEN PRO.PRODUCT_ID ELSE PF.PRODUCT_ID END) AS PRODUCT_ID,
			            PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,(CASE WHEN PT.TEMPLATE_ID IS NULL THEN PRO.TEMPLATE_ID ELSE PT.TEMPLATE_ID END) AS TEMPLATE_ID,
			            (CASE WHEN PT.TEMPLATE_ID IS NULL THEN (SELECT TEMPLATE_NAME FROM PDT_TEMPLATE WHERE TEMPLATE_ID=PRO.TEMPLATE_ID) ELSE PT.TEMPLATE_NAME END) AS TEMPLATE_NAME,
			            PT.TEMPLATE_FIELD_ID,PT.FIELD_CODEDATA_VALUE 
			            FROM PDT_PRODUCT_FIELD AS PF 
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			            RIGHT JOIN PDT_PRODUCT AS PRO ON PRO.PRODUCT_ID=PF.PRODUCT_ID AND PRO.IS_DEL=0
			        ) AS PA 
			        LEFT JOIN (
			            SELECT PCUS.PRODUCT_ID,PCUS.USER_ID,SUM(PCUS.BUY_MONEY) AS BUY_MONEY
			            FROM PDT_PRODUCT_CUSTOMER AS PCUS 
			            WHERE PCUS.IS_DEL=0 
		 ]]>
		<isNotEmpty property="startDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')>='$startDate$' ]]>
		</isNotEmpty>
		<isNotEmpty property="endDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')<='$endDate$' ]]>
		</isNotEmpty>
		<![CDATA[
			            GROUP BY PCUS.PRODUCT_ID,PCUS.USER_ID
			        ) AS PC ON PA.PRODUCT_ID=PC.PRODUCT_ID 
			    ) AS P ON P.USER_ID=USERS.USER_ID AND USERS.IS_DEL=0
			    WHERE USERS.USER_ID IN($userIds$) 
			    UNION ALL 
			    SELECT DISTINCT PP.PRODUCT_ID,PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,PP.TEMPLATE_ID,PP.TEMPLATE_NAME,
			    PP.TEMPLATE_FIELD_ID,PP.FIELD_CODEDATA_VALUE,PRO.USER_ID,0 AS BUY_MONEY,PRO.USER_NAME,PRO.DEPT_ID 
			    FROM (
			        SELECT PF.PRODUCT_ID,PT.*FROM PDT_PRODUCT_FIELD AS PF
			        INNER JOIN(
			            SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			            FROM PDT_FIELD_CODEDATA AS CODE
			            LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			            LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			            WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			        ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        UNION ALL
			        SELECT A.*,B.TEMPLATE_FIELD_ID,B.FIELD_CODEDATA_VALUE FROM (
			            SELECT PDT.PRODUCT_ID,PDT.TEMPLATE_ID,TEM.TEMPLATE_NAME
			            FROM PDT_PRODUCT AS PDT
			            INNER JOIN(
			                SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			                TSK_MARKETING_EXECUTE AS EXC
			                LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			                LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			                WHERE EXC.USER_ID IN($userIds$)
			            ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			            LEFT JOIN PDT_TEMPLATE AS TEM ON TEM.TEMPLATE_ID=PDT.TEMPLATE_ID
			        ) AS A 
			        LEFT JOIN(
			            SELECT PF.PRODUCT_ID,PT.*
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        ) AS B ON A.PRODUCT_ID=B.PRODUCT_ID
			    ) AS PP
			    RIGHT JOIN(
			        SELECT PDT.PRODUCT_ID,PDT.PRODUCT_CODE,PDT.PRODUCT_NAME,PDT.TEMPLATE_ID,MP.USER_ID,MP.USER_NAME,MP.DEPT_ID
			        FROM PDT_PRODUCT AS PDT
			        INNER JOIN(
			            SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			            TSK_MARKETING_EXECUTE AS EXC
			            LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			            LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			            WHERE EXC.USER_ID IN($userIds$)
			        ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			    )AS PRO ON PRO.PRODUCT_ID=PP.PRODUCT_ID
			) AS PU WHERE 1=1 
		]]>
		<isNotEmpty property="startEndDate">
			<![CDATA[ $startEndDate$ ]]>
		</isNotEmpty>
		<isNotEmpty property="proId">
			<![CDATA[ AND  PU.PRODUCT_ID IN($proId$) ]]>
		</isNotEmpty>
		<![CDATA[
			GROUP BY PU.TEMPLATE_FIELD_ID,PU.FIELD_CODEDATA_VALUE,PU.USER_ID,PU.DEPT_ID,PU.TEMPLATE_ID order by PU.USER_ID 
		]]>
	</select>
	
	<!-- 统计对象机构 -->
	
	<!-- 统计部门的产品信息列表-->
	<select id="GetProductReportDeptList" resultMap="ProductReportBeanResult" parameterClass="java.util.Map">
		<![CDATA[
			SELECT PU.PRODUCT_ID,PU.PRODUCT_CODE,PU.PRODUCT_NAME,PU.TEMPLATE_ID,PU.TEMPLATE_NAME,PU.TEMPLATE_FIELD_ID,PU.FIELD_CODEDATA_VALUE,
			PU.DEPT_ID AS USER_ID,SUM(BUY_MONEY) AS BUY_MONEY,0 AS DEPT_ID,'' AS USER_NAME
			FROM(
			    SELECT P.*,USERS.USER_NAME,USERS.DEPT_ID FROM (SELECT USER_ID,USER_NAME,DEPT_ID,IS_DEL FROM SYS_USER UNION ALL SELECT COUNTER_USER_ID AS USER_ID,COUNTER_USER_NAME AS USER_NAME,DEPT_ID,IS_DEL FROM CRM_COUNTER_USER) AS USERS
			    RIGHT JOIN(
			        SELECT PA.*,PC.USER_ID,PC.BUY_MONEY FROM(
			            SELECT (CASE WHEN PF.PRODUCT_ID IS NULL THEN PRO.PRODUCT_ID ELSE PF.PRODUCT_ID END) AS PRODUCT_ID,
			            PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,(CASE WHEN PT.TEMPLATE_ID IS NULL THEN PRO.TEMPLATE_ID ELSE PT.TEMPLATE_ID END) AS TEMPLATE_ID,
			            (CASE WHEN PT.TEMPLATE_ID IS NULL THEN (SELECT TEMPLATE_NAME FROM PDT_TEMPLATE WHERE TEMPLATE_ID=PRO.TEMPLATE_ID) ELSE PT.TEMPLATE_NAME END) AS TEMPLATE_NAME,
			            PT.TEMPLATE_FIELD_ID,PT.FIELD_CODEDATA_VALUE 
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			            RIGHT JOIN PDT_PRODUCT AS PRO ON PRO.PRODUCT_ID=PF.PRODUCT_ID AND PRO.IS_DEL=0
			        ) AS PA
			        LEFT JOIN (
			            SELECT PCUS.PRODUCT_ID,(
			                CASE WHEN PCUS.USER_ID IS NULL THEN PCUS.COUNTER_USER_ID ELSE PCUS.USER_ID END
			            ) AS USER_ID,SUM(PCUS.BUY_MONEY) AS BUY_MONEY
			            FROM PDT_PRODUCT_CUSTOMER AS PCUS 
			            WHERE PCUS.IS_DEL=0 
		 ]]>
		<isNotEmpty property="startDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')>='$startDate$' ]]>
		</isNotEmpty>
		<isNotEmpty property="endDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')<='$endDate$' ]]>
		</isNotEmpty>
		<![CDATA[
			            GROUP BY PCUS.PRODUCT_ID,PCUS.USER_ID,PCUS.COUNTER_USER_ID
			        ) AS PC ON PA.PRODUCT_ID=PC.PRODUCT_ID
			    ) AS P ON P.USER_ID=USERS.USER_ID 
			    WHERE USERS.USER_ID IN($userIds$)
			    UNION ALL
			    SELECT DISTINCT PP.PRODUCT_ID,PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,PP.TEMPLATE_ID,PP.TEMPLATE_NAME,
			    PP.TEMPLATE_FIELD_ID,PP.FIELD_CODEDATA_VALUE,PRO.USER_ID,0 AS BUY_MONEY,PRO.USER_NAME,PRO.DEPT_ID 
			    FROM (
			        SELECT PF.PRODUCT_ID,PT.*FROM PDT_PRODUCT_FIELD AS PF
			        INNER JOIN(
			            SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			            FROM PDT_FIELD_CODEDATA AS CODE
			            LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			            LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			            WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			        ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        UNION ALL
			        SELECT A.*,B.TEMPLATE_FIELD_ID,B.FIELD_CODEDATA_VALUE FROM (
			            SELECT PDT.PRODUCT_ID,PDT.TEMPLATE_ID,TEM.TEMPLATE_NAME
			            FROM PDT_PRODUCT AS PDT
			            INNER JOIN(
			                SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			                TSK_MARKETING_EXECUTE AS EXC
			                LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			                LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			                WHERE EXC.USER_ID IN($userIds$)
			            ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			            LEFT JOIN PDT_TEMPLATE AS TEM ON TEM.TEMPLATE_ID=PDT.TEMPLATE_ID
			        ) AS A 
			        LEFT JOIN(
			            SELECT PF.PRODUCT_ID,PT.*
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        ) AS B ON A.PRODUCT_ID=B.PRODUCT_ID
			    ) AS PP
			    RIGHT JOIN(
			        SELECT PDT.PRODUCT_ID,PDT.PRODUCT_CODE,PDT.PRODUCT_NAME,PDT.TEMPLATE_ID,MP.USER_ID,MP.USER_NAME,MP.DEPT_ID
			        FROM PDT_PRODUCT AS PDT
			        INNER JOIN(
			            SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			            TSK_MARKETING_EXECUTE AS EXC
			            LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			            LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			            WHERE EXC.USER_ID IN($userIds$)
			        ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			    )AS PRO ON PRO.PRODUCT_ID=PP.PRODUCT_ID
			) AS PU
			WHERE 1=1 
		]]>
		<isNotEmpty property="startEndDate">
			<![CDATA[ $startEndDate$ ]]>
		</isNotEmpty>
		<isNotEmpty property="proId">
			<![CDATA[ AND  PU.PRODUCT_ID IN($proId$) ]]>
		</isNotEmpty>
		<![CDATA[
			GROUP BY PU.PRODUCT_ID,PU.PRODUCT_CODE,PU.PRODUCT_NAME,PU.TEMPLATE_ID,PU.TEMPLATE_FIELD_ID,PU.FIELD_CODEDATA_VALUE,PU.TEMPLATE_NAME,PU.DEPT_ID 
			ORDER BY PU.DEPT_ID 
		]]>
	</select>
	
	<!-- 统计部门对应的产品数-->
	<select id="GetProductDeptList" resultMap="ProductTypeTreeBeanResult" parameterClass="java.util.Map">
		<![CDATA[
			SELECT A.DEPT_ID AS ID, A.DEPT_NAME AS NAME,SUM(PARENT_ID) AS PARENT_ID,A.CODE,A.TYPE FROM(
		    SELECT DISTINCT B.*,DEPT.DEPT_NAME FROM(
		        SELECT PU.* FROM(
		            SELECT DISTINCT 1 AS PARENT_ID,'' AS CODE,'' AS TYPE,PDT.PRODUCT_ID,U.DEPT_ID
		            FROM PDT_PRODUCT_CUSTOMER AS CT
		            INNER JOIN PDT_PRODUCT AS PDT ON PDT.PRODUCT_ID=CT.PRODUCT_ID AND PDT.IS_DEL=0
		            LEFT JOIN (SELECT USER_ID,USER_NAME,DEPT_ID,IS_DEL FROM SYS_USER UNION ALL SELECT COUNTER_USER_ID AS USER_ID,COUNTER_USER_NAME AS USER_NAME,DEPT_ID,IS_DEL FROM CRM_COUNTER_USER) AS U ON U.USER_ID=CT.USER_ID 
            		OR U.USER_ID=CT.COUNTER_USER_ID 
		            WHERE CT.IS_DEL=0 AND CT.USER_ID IN($userIds$)
		            AND CT.USER_ID IN(
		                SELECT DISTINCT a.USER_ID FROM SYS_USER a LEFT JOIN SYS_ROLE_MEMBER b  ON a.USER_ID=b.USER_ID  
		                WHERE b.ROLE_ID IN (3,4) AND a.DEPT_ID IN($deptIds$) AND a.IS_DEL=0
		            )
		 ]]>
		 <isNotEmpty property="dids">
		 	<![CDATA[ OR CT.COUNTER_USER_ID IN($dids$) ]]>
		 </isNotEmpty> 
		 <![CDATA[
		        ) AS PU WHERE 1=1 AND PU.PRODUCT_ID<>0 
		 ]]>
		<isNotEmpty property="startEndDate">
			<![CDATA[ $startEndDate$ ]]>
		</isNotEmpty>
		<isNotEmpty property="proId">
			<![CDATA[ AND  PU.PRODUCT_ID IN($proId$) ]]>
		</isNotEmpty>
		<![CDATA[
		        UNION ALL
		        SELECT PU.* FROM (
		            SELECT DISTINCT 1 AS PARENT_ID,'' AS CODE,'' AS TYPE,MARK.PRODUCT_ID,U.DEPT_ID
		            FROM TSK_MARKETING_EXECUTE AS EXC
		            INNER JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
		            LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
		            WHERE EXC.USER_ID IN($userIds$)
		            AND U.USER_ID IN(
		                SELECT DISTINCT a.USER_ID FROM SYS_USER a LEFT JOIN SYS_ROLE_MEMBER b  ON a.USER_ID=b.USER_ID  
		                WHERE b.ROLE_ID IN (3,4) AND a.DEPT_ID IN($deptIds$) AND a.IS_DEL=0
		            ) 
		        ) AS PU WHERE 1=1 AND PU.PRODUCT_ID<>0 
		  ]]>
		<isNotEmpty property="startEndDate">
			<![CDATA[ $startEndDate$ ]]>
		</isNotEmpty>
		<isNotEmpty property="proId">
			<![CDATA[ AND  PU.PRODUCT_ID IN($proId$) ]]>
		</isNotEmpty>
		<![CDATA[
		    ) AS B 
		    LEFT JOIN SYS_DEPT AS DEPT ON DEPT.DEPT_ID=B.DEPT_ID 
		) AS A GROUP BY A.DEPT_ID,A.CODE,A.TYPE,A.DEPT_NAME 
		]]>
	</select>
	
	<!-- 统计部门产品大类的营销额 -->
	<select id="GetProductTypeTotalDeptList" resultMap="ProductTypeTotalBeanResult" parameterClass="java.util.Map">
		<![CDATA[
			SELECT PU.TEMPLATE_ID,PU.TEMPLATE_NAME,0 AS DEPT_ID,PU.DEPT_ID AS USER_ID,SUM(BUY_MONEY) AS BUY_MONEY,PU.TEMPLATE_ID AS FARTHER_ID 
			FROM(
			    SELECT P.*,USERS.USER_NAME,USERS.DEPT_ID FROM (SELECT USER_ID,USER_NAME,DEPT_ID,IS_DEL FROM SYS_USER UNION ALL SELECT COUNTER_USER_ID AS USER_ID,COUNTER_USER_NAME AS USER_NAME,DEPT_ID,IS_DEL FROM CRM_COUNTER_USER) AS USERS
			    RIGHT JOIN(
			        SELECT PA.*,PC.USER_ID,PC.BUY_MONEY FROM(
			            SELECT (CASE WHEN PF.PRODUCT_ID IS NULL THEN PRO.PRODUCT_ID ELSE PF.PRODUCT_ID END) AS PRODUCT_ID,
			            PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,(CASE WHEN PT.TEMPLATE_ID IS NULL THEN PRO.TEMPLATE_ID ELSE PT.TEMPLATE_ID END) AS TEMPLATE_ID,
			            (CASE WHEN PT.TEMPLATE_ID IS NULL THEN (SELECT TEMPLATE_NAME FROM PDT_TEMPLATE WHERE TEMPLATE_ID=PRO.TEMPLATE_ID) ELSE PT.TEMPLATE_NAME END) AS TEMPLATE_NAME,
			            PT.TEMPLATE_FIELD_ID,PT.FIELD_CODEDATA_VALUE 
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			            RIGHT JOIN PDT_PRODUCT AS PRO ON PRO.PRODUCT_ID=PF.PRODUCT_ID AND PRO.IS_DEL=0
			        ) AS PA
			        LEFT JOIN (
			            SELECT PCUS.PRODUCT_ID,(
			                CASE WHEN PCUS.USER_ID IS NULL THEN PCUS.COUNTER_USER_ID ELSE PCUS.USER_ID END
			            ) AS USER_ID,SUM(PCUS.BUY_MONEY) AS BUY_MONEY
			            FROM PDT_PRODUCT_CUSTOMER AS PCUS 
			            WHERE PCUS.IS_DEL=0 
		]]>
		<isNotEmpty property="startDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')>='$startDate$' ]]>
		</isNotEmpty>
		<isNotEmpty property="endDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')<='$endDate$' ]]>
		</isNotEmpty>
		<![CDATA[
			            GROUP BY PCUS.PRODUCT_ID,PCUS.USER_ID,PCUS.COUNTER_USER_ID
			        ) AS PC ON PA.PRODUCT_ID=PC.PRODUCT_ID
			    ) AS P ON P.USER_ID=USERS.USER_ID 
			    WHERE USERS.USER_ID IN($userIds$)
			    UNION ALL
			    SELECT DISTINCT PP.PRODUCT_ID,PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,PP.TEMPLATE_ID,PP.TEMPLATE_NAME,
			    PP.TEMPLATE_FIELD_ID,PP.FIELD_CODEDATA_VALUE,PRO.USER_ID,0 AS BUY_MONEY,PRO.USER_NAME,PRO.DEPT_ID 
			    FROM (
			        SELECT PF.PRODUCT_ID,PT.*FROM PDT_PRODUCT_FIELD AS PF
			        INNER JOIN(
			            SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			            FROM PDT_FIELD_CODEDATA AS CODE
			            LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			            LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			            WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			        ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        UNION ALL
			        SELECT A.*,B.TEMPLATE_FIELD_ID,B.FIELD_CODEDATA_VALUE FROM (
			            SELECT PDT.PRODUCT_ID,PDT.TEMPLATE_ID,TEM.TEMPLATE_NAME
			            FROM PDT_PRODUCT AS PDT
			            INNER JOIN(
			                SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			                TSK_MARKETING_EXECUTE AS EXC
			                LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			                LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			                WHERE EXC.USER_ID IN($userIds$)
			            ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			            LEFT JOIN PDT_TEMPLATE AS TEM ON TEM.TEMPLATE_ID=PDT.TEMPLATE_ID
			        ) AS A 
			        LEFT JOIN(
			            SELECT PF.PRODUCT_ID,PT.*
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        ) AS B ON A.PRODUCT_ID=B.PRODUCT_ID
			    ) AS PP
			    RIGHT JOIN(
			        SELECT PDT.PRODUCT_ID,PDT.PRODUCT_CODE,PDT.PRODUCT_NAME,PDT.TEMPLATE_ID,MP.USER_ID,MP.USER_NAME,MP.DEPT_ID
			        FROM PDT_PRODUCT AS PDT
			        INNER JOIN(
			            SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			            TSK_MARKETING_EXECUTE AS EXC
			            LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			            LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			            WHERE EXC.USER_ID IN($userIds$)
			        ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			    )AS PRO ON PRO.PRODUCT_ID=PP.PRODUCT_ID
			) AS PU
			WHERE 1=1 
		]]>
		<isNotEmpty property="startEndDate">
			<![CDATA[ $startEndDate$ ]]>
		</isNotEmpty>
		<isNotEmpty property="proId">
			<![CDATA[ AND  PU.PRODUCT_ID IN($proId$) ]]>
		</isNotEmpty>
		<![CDATA[
			GROUP BY PU.TEMPLATE_ID,PU.TEMPLATE_NAME,PU.DEPT_ID,PU.TEMPLATE_ID order by PU.DEPT_ID
		]]>
	</select>
	
	<!-- 统计部门产品子类型的销售额-->
	<select id="GetProductSubTypeDeptTotalList" resultMap="ProductTypeTotalBeanResult" parameterClass="java.util.Map">
		<![CDATA[
			SELECT PU.TEMPLATE_FIELD_ID  AS TEMPLATE_ID,PU.FIELD_CODEDATA_VALUE AS TEMPLATE_NAME,0 AS DEPT_ID,PU.DEPT_ID AS USER_ID,
			SUM(BUY_MONEY) AS BUY_MONEY,PU.TEMPLATE_ID AS FARTHER_ID
			FROM(
			    SELECT P.*,USERS.USER_NAME,USERS.DEPT_ID FROM (SELECT USER_ID,USER_NAME,DEPT_ID,IS_DEL FROM SYS_USER UNION ALL SELECT COUNTER_USER_ID AS USER_ID,COUNTER_USER_NAME AS USER_NAME,DEPT_ID,IS_DEL FROM CRM_COUNTER_USER) AS USERS
			    RIGHT JOIN(
			        SELECT PA.*,PC.USER_ID,PC.BUY_MONEY FROM(
			            SELECT (CASE WHEN PF.PRODUCT_ID IS NULL THEN PRO.PRODUCT_ID ELSE PF.PRODUCT_ID END) AS PRODUCT_ID,
			            PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,(CASE WHEN PT.TEMPLATE_ID IS NULL THEN PRO.TEMPLATE_ID ELSE PT.TEMPLATE_ID END) AS TEMPLATE_ID,
			            (CASE WHEN PT.TEMPLATE_ID IS NULL THEN (SELECT TEMPLATE_NAME FROM PDT_TEMPLATE WHERE TEMPLATE_ID=PRO.TEMPLATE_ID) ELSE PT.TEMPLATE_NAME END) AS TEMPLATE_NAME,
			            PT.TEMPLATE_FIELD_ID,PT.FIELD_CODEDATA_VALUE 
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			            RIGHT JOIN PDT_PRODUCT AS PRO ON PRO.PRODUCT_ID=PF.PRODUCT_ID AND PRO.IS_DEL=0
			        ) AS PA
			        LEFT JOIN (
			            SELECT PCUS.PRODUCT_ID,(
			                CASE WHEN PCUS.USER_ID IS NULL THEN PCUS.COUNTER_USER_ID ELSE PCUS.USER_ID END
			            ) AS USER_ID,SUM(PCUS.BUY_MONEY) AS BUY_MONEY
			            FROM PDT_PRODUCT_CUSTOMER AS PCUS 
			            WHERE PCUS.IS_DEL=0 
		]]>
		<isNotEmpty property="startDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')>='$startDate$' ]]>
		</isNotEmpty>
		<isNotEmpty property="endDate">
			<![CDATA[ AND TO_CHAR(PCUS.BUY_DATE,'yyyy-MM-dd')<='$endDate$' ]]>
		</isNotEmpty>
		<![CDATA[
			            GROUP BY PCUS.PRODUCT_ID,PCUS.USER_ID,PCUS.COUNTER_USER_ID
			        ) AS PC ON PA.PRODUCT_ID=PC.PRODUCT_ID
			    ) AS P ON P.USER_ID=USERS.USER_ID 
			    WHERE USERS.USER_ID IN($userIds$)
			    UNION ALL
			    SELECT DISTINCT PP.PRODUCT_ID,PRO.PRODUCT_CODE,PRO.PRODUCT_NAME,PP.TEMPLATE_ID,PP.TEMPLATE_NAME,
			    PP.TEMPLATE_FIELD_ID,PP.FIELD_CODEDATA_VALUE,PRO.USER_ID,0 AS BUY_MONEY,PRO.USER_NAME,PRO.DEPT_ID 
			    FROM (
			        SELECT PF.PRODUCT_ID,PT.*FROM PDT_PRODUCT_FIELD AS PF
			        INNER JOIN(
			            SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			            FROM PDT_FIELD_CODEDATA AS CODE
			            LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			            LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			            WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			        ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        UNION ALL
			        SELECT A.*,B.TEMPLATE_FIELD_ID,B.FIELD_CODEDATA_VALUE FROM (
			            SELECT PDT.PRODUCT_ID,PDT.TEMPLATE_ID,TEM.TEMPLATE_NAME
			            FROM PDT_PRODUCT AS PDT
			            INNER JOIN(
			                SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			                TSK_MARKETING_EXECUTE AS EXC
			                LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			                LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			                WHERE EXC.USER_ID IN($userIds$)
			            ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			            LEFT JOIN PDT_TEMPLATE AS TEM ON TEM.TEMPLATE_ID=PDT.TEMPLATE_ID
			        ) AS A 
			        LEFT JOIN(
			            SELECT PF.PRODUCT_ID,PT.*
			            FROM PDT_PRODUCT_FIELD AS PF
			            INNER JOIN(
			                SELECT FIELD.TEMPLATE_ID,TEMP.TEMPLATE_NAME,CODE.FIELD_CODEDATA_ID AS TEMPLATE_FIELD_ID,CODE.FIELD_CODEDATA_VALUE
			                FROM PDT_FIELD_CODEDATA AS CODE
			                LEFT JOIN PDT_TEMPLATE_FIELD AS FIELD ON FIELD.TEMPLATE_FIELD_ID=CODE.TEMPLATE_FIELD_ID
			                LEFT JOIN PDT_TEMPLATE AS TEMP ON TEMP.TEMPLATE_ID=FIELD.TEMPLATE_ID
			                WHERE FIELD.IS_DEL=0 AND TEMP.IS_DEL=0 AND FIELD.IS_BUILTIN=1 AND CODE.IS_DEL=0
			            ) AS PT ON PT.FIELD_CODEDATA_VALUE=PF.FIELD_VALUE_STRING 
			        ) AS B ON A.PRODUCT_ID=B.PRODUCT_ID
			    ) AS PP
			    RIGHT JOIN(
			        SELECT PDT.PRODUCT_ID,PDT.PRODUCT_CODE,PDT.PRODUCT_NAME,PDT.TEMPLATE_ID,MP.USER_ID,MP.USER_NAME,MP.DEPT_ID
			        FROM PDT_PRODUCT AS PDT
			        INNER JOIN(
			            SELECT EXC.USER_ID,U.USER_NAME,MARK.PRODUCT_ID,U.DEPT_ID FROM 
			            TSK_MARKETING_EXECUTE AS EXC
			            LEFT JOIN TSK_MARKETING AS MARK ON EXC.MARKETING_ID=MARK.MARKETING_ID AND MARK.IS_DEL=0
			            LEFT JOIN SYS_USER AS U ON U.USER_ID=EXC.USER_ID 
			            WHERE EXC.USER_ID IN($userIds$)
			        ) AS MP ON MP.PRODUCT_ID=PDT.PRODUCT_ID
			    )AS PRO ON PRO.PRODUCT_ID=PP.PRODUCT_ID
			) AS PU 
			WHERE 1=1
		]]>
		<isNotEmpty property="startEndDate">
			<![CDATA[ $startEndDate$ ]]>
		</isNotEmpty>
		<isNotEmpty property="proId">
			<![CDATA[ AND  PU.PRODUCT_ID IN($proId$) ]]>
		</isNotEmpty>
		<![CDATA[
			GROUP BY PU.TEMPLATE_FIELD_ID,PU.FIELD_CODEDATA_VALUE,PU.DEPT_ID,PU.TEMPLATE_ID order by PU.DEPT_ID
		]]>
	</select>
</sqlMap>
